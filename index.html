<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>廣告替換工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papa-parse/5.3.0/papaparse.min.js"></script>
    <style>
        /* 保持原有樣式 */
    </style>
</head>
<body>
    <div class="container">
        <h1>廣告替換工具</h1>
        <div id="debug" style="background:#fff3cd;padding:10px;margin:10px 0;display:none;"></div>
        
        <div class="upload-area">
            <input type="file" id="fileInput" accept=".csv">
            <p>選擇或拖放CSV檔案至此處</p>
            <div id="fileName"></div>
        </div>

        <div id="preview" class="preview-area">
            <h2>預覽資料</h2>
            <div id="previewContent"></div>
        </div>

        <div id="bookmark" class="bookmark-area">
            <h2>書籤代碼</h2>
            <div id="bookmarkCode" class="code"></div>
            <button onclick="copyCode()">複製代碼</button>
        </div>
    </div>

    <script>
        // 添加除錯函數
        function debug(msg) {
            console.log(msg);
            const debugArea = document.getElementById('debug');
            debugArea.style.display = 'block';
            debugArea.innerHTML += `<div>${msg}</div>`;
        }

        function handleFile(file) {
            debug(`開始處理文件: ${file.name}`);
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                debug('文件讀取完成，開始解析CSV');
                
                Papa.parse(e.target.result, {
                    header: true,
                    complete: function(results) {
                        debug(`CSV解析完成，數據行數: ${results.data.length}`);
                        debug(`欄位: ${Object.keys(results.data[0]).join(', ')}`);
                        
                        if (results.errors.length > 0) {
                            debug(`解析錯誤: ${JSON.stringify(results.errors)}`);
                            return;
                        }

                        // 顯示預覽
                        showPreview(results.data);
                        // 生成代碼
                        generateCode(results.data);
                    },
                    error: function(error) {
                        debug(`解析錯誤: ${error}`);
                    }
                });
            };
            
            reader.onerror = function() {
                debug('文件讀取錯誤');
            };
            
            reader.readAsText(file);
        }

        function showPreview(data) {
            debug('顯示預覽資料');
            const preview = document.getElementById('preview');
            const content = document.getElementById('previewContent');
            
            let table = '<table><tr>';
            const headers = Object.keys(data[0]);
            headers.forEach(header => table += `<th>${header}</th>`);
            table += '</tr>';
            
            data.forEach(row => {
                table += '<tr>';
                headers.forEach(header => table += `<td>${row[header]}</td>`);
                table += '</tr>';
            });
            table += '</table>';
            
            content.innerHTML = table;
            preview.style.display = 'block';
            debug('預覽資料顯示完成');
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            debug('檔案選擇事件觸發');
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = `已選擇: ${file.name}`;
                handleFile(file);
            }
        });

        // 拖放功能
        const dropZone = document.querySelector('.upload-area');
        dropZone.addEventListener('dragover', e => e.preventDefault());
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            debug('檔案拖放事件觸發');
            const file = e.dataTransfer.files[0];
            if (file) {
                document.getElementById('fileName').textContent = `已選擇: ${file.name}`;
                handleFile(file);
            }
        });
    </script>
</body>
</html>
