<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>廣告替換工具</title>
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            background: #fafafa;
            border-radius: 4px;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .preview-table th, .preview-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .preview-table th {
            background: #f5f5f5;
        }
        .hidden {
            display: none;
        }
        #bookmarkCode {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-break: break-all;
            border: 1px solid #ddd;
            margin: 10px 0;
            font-family: monospace;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        .section {
            margin: 20px 0;
        }
        .section-title {
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>廣告替換工具</h1>
        
        <div id="status"></div>

        <div class="section">
            <div class="upload-area" id="dropZone">
                <input type="file" id="fileInput" accept=".csv">
                <p>選擇或拖放 CSV 檔案至此處</p>
                <p style="color: #666; font-size: 14px;">支援的欄位：imageUrl, title, brand, size</p>
            </div>
        </div>

        <div id="previewArea" class="section hidden">
            <div class="section-title">預覽資料</div>
            <div id="previewContent"></div>
        </div>

        <div id="codeArea" class="section hidden">
            <div class="section-title">書籤代碼</div>
            <pre id="bookmarkCode"></pre>
            <button onclick="copyToClipboard()">複製代碼</button>
        </div>
    </div>

    <script>
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.style.background = type === 'error' ? '#ffebee' : '#e8f5e9';
            statusDiv.style.display = 'block';
        }

        function processFile(file) {
            showStatus('正在處理檔案...');
            
            if (!window.Papa) {
                showStatus('CSV 解析器尚未載入，請重新整理頁面', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                Papa.parse(e.target.result, {
                    header: true,
                    encoding: 'big5',
                    complete: function(results) {
                        if (results.errors.length) {
                            showStatus('CSV 解析錯誤: ' + results.errors[0].message, 'error');
                            return;
                        }

                        const data = results.data;
                        if (!data.length) {
                            showStatus('CSV 檔案沒有資料', 'error');
                            return;
                        }

                        showPreview(data);
                        generateBookmarkCode(data);
                        showStatus('處理完成！');
                    },
                    error: function(error) {
                        showStatus('檔案處理錯誤: ' + error.message, 'error');
                    }
                });
            };
            reader.readAsText(file, 'big5');
        }

        function showPreview(data) {
            const previewArea = document.getElementById('previewArea');
            const content = document.getElementById('previewContent');
            
            let table = '<table class="preview-table"><tr>';
            const headers = Object.keys(data[0]);
            headers.forEach(header => table += `<th>${header}</th>`);
            table += '</tr>';
            
            data.forEach(row => {
                table += '<tr>';
                headers.forEach(header => table += `<td>${row[header] || ''}</td>`);
                table += '</tr>';
            });
            table += '</table>';
            
            content.innerHTML = table;
            previewArea.classList.remove('hidden');
        }

        function generateBookmarkCode(data) {
            const code = `javascript:(function(){
                const adData = ${JSON.stringify(data)};
                
                // 按尺寸分組廣告數據
                const adsBySize = {};
                adData.forEach(item => {
                    if (!adsBySize[item.size]) {
                        adsBySize[item.size] = [];
                    }
                    adsBySize[item.size].push(item);
                });

                let replacedCount = 0;
                const selectors = [
                    'ins.adsbygoogle',
                    'div[id^="google_ads_iframe"]',
                    'div[id^="div-gpt-ad"]',
                    'div[data-ad-client]',
                    'div[class*="gpt-ad"]',
                    'iframe[id^="google_ads_iframe"]',
                    'div[class*="adsky"]'
                ];

                // 為每個尺寸找到對應的廣告位
                Object.keys(adsBySize).forEach(size => {
                    const [width, height] = size.split('x').map(Number);
                    let currentIndex = 0;
                    
                    selectors.forEach(selector => {
                        document.querySelectorAll(selector).forEach(ad => {
                            if (ad.offsetWidth === width && ad.offsetHeight === height) {
                                // 使用當前尺寸的下一個廣告內容
                                const item = adsBySize[size][currentIndex % adsBySize[size].length];
                                const adContainer = ad.tagName === 'IFRAME' ? ad.parentElement : ad;
                                
                                adContainer.innerHTML = '';
                                adContainer.style.width = width + 'px';
                                adContainer.style.height = height + 'px';
                                adContainer.style.overflow = 'hidden';
                                adContainer.style.position = 'relative';
                                
                                if (width === 300 && height === 250) {
                                    adContainer.innerHTML = \`
                                        <div style="width:300px;height:157px;overflow:hidden">
                                            <img src="\${item.imageUrl}" style="width:300px;height:157px;display:block">
                                        </div>
                                        <div style="height:93px;padding:12px 25px 0 25px;position:relative">
                                            <div style="font-size:18px;line-height:1.5;font-weight:bold;height:54px;overflow:hidden">\${item.title}</div>
                                            <div style="font-size:9px;color:#999999;position:absolute;bottom:15px;left:25px">\${item.brand}</div>
                                            <div style="position:absolute;bottom:15px;right:25px;background:#4397F1;color:white;font-size:10px;padding:3px 8px;border-radius:4px;font-weight:bold">開啟</div>
                                        </div>
                                    \`;
                                } else if (width === 970 && height === 250) {
                                    adContainer.style.display = 'flex';
                                    adContainer.innerHTML = \`
                                        <div style="width:478px;height:250px;overflow:hidden">
                                            <img src="\${item.imageUrl}" style="width:478px;height:250px;display:block">
                                        </div>
                                        <div style="width:492px;height:250px;padding:20px 25px;position:relative;box-sizing:border-box">
                                            <div style="font-size:26px;line-height:1.8;font-weight:bold;color:#666666;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">\${item.title}</div>
                                            <div style="font-size:13px;color:#999999;position:absolute;bottom:20px;left:25px">\${item.brand}</div>
                                            <div style="position:absolute;bottom:20px;right:25px;background:#4397F1;color:white;font-size:14px;padding:4px 10px;border-radius:4px;font-weight:bold">開啟</div>
                                        </div>
                                    \`;
                                }
                                
                                currentIndex++;
                                replacedCount++;
                            }
                        });
                    });
                });
                
                alert(\`已替換 \${replacedCount} 個廣告位\`);
            })();`;
            
            document.getElementById('bookmarkCode').textContent = code;
            document.getElementById('codeArea').classList.remove('hidden');
        }

        function copyToClipboard() {
            const code = document.getElementById('bookmarkCode').textContent;
            navigator.clipboard.writeText(code)
                .then(() => showStatus('代碼已複製到剪貼板！'))
                .catch(() => showStatus('複製失敗，請手動複製', 'error'));
        }

        document.getElementById('fileInput').addEventListener('change', event => {
            const file = event.target.files[0];
            if (file) processFile(file);
        });

        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('dragover', e => e.preventDefault());
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });

        window.onload = function() {
            if (!window.Papa) {
                showStatus('無法載入 CSV 解析器，請重新整理頁面', 'error');
            } else {
                showStatus('系統已準備就緒，請選擇 CSV 檔案');
            }
        };
    </script>
</body>
</html>
