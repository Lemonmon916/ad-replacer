<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>廣告替換工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papa-parse/5.3.0/papaparse.min.js"></script>
    <!-- 其他 head 內容保持不變 -->
</head>
<body>
    <!-- HTML 結構保持不變 -->
    <script>
        // 檔案處理函數
        function handleFile(file) {
            console.log('開始處理檔案:', file.name); // 除錯日誌
            
            if (!file) {
                console.error('沒有檔案被選擇');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                console.log('檔案讀取完成'); // 除錯日誌
                
                try {
                    Papa.parse(e.target.result, {
                        header: true,
                        complete: function(results) {
                            console.log('CSV 解析結果:', results); // 除錯日誌
                            
                            if (results.errors.length > 0) {
                                console.error('CSV 解析錯誤:', results.errors);
                                alert('CSV檔案格式錯誤: ' + results.errors[0].message);
                                return;
                            }

                            if (!results.data || results.data.length === 0) {
                                console.error('沒有資料');
                                alert('CSV檔案沒有資料');
                                return;
                            }

                            // 顯示預覽
                            displayPreview(results.data);
                            
                            // 生成書籤代碼
                            generateBookmarkCode(results.data);
                            
                            console.log('處理完成'); // 除錯日誌
                        },
                        error: function(error) {
                            console.error('解析錯誤:', error);
                            alert('檔案處理失敗: ' + error.message);
                        }
                    });
                } catch (e) {
                    console.error('處理過程發生錯誤:', e);
                    alert('處理過程發生錯誤: ' + e.message);
                }
            };

            reader.onerror = function() {
                console.error('檔案讀取錯誤');
                alert('檔案讀取錯誤');
            };

            reader.readAsText(file);
        }

        // 顯示預覽
        function displayPreview(data) {
            console.log('顯示預覽，資料:', data); // 除錯日誌
            
            const container = document.getElementById('previewArea');
            const table = document.createElement('table');
            
            // 創建表頭
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // 創建表體
            const tbody = document.createElement('tbody');
            data.forEach(row => {
                const tr = document.createElement('tr');
                Object.keys(row).forEach(key => {
                    const td = document.createElement('td');
                    td.textContent = row[key];
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            
            // 清空並添加新表格
            container.innerHTML = '';
            container.appendChild(table);
            container.classList.remove('hidden');
        }

        // 生成書籤代碼
        function generateBookmarkCode(data) {
            console.log('生成書籤代碼'); // 除錯日誌
            
            const codeArea = document.getElementById('bookmarkArea');
            const codeElement = document.getElementById('bookmarkCode');
            
            // 將資料轉換為書籤代碼
            const bookmarkCode = `javascript:(function(){
                const adData = ${JSON.stringify(data)};
                // 原始替換邏輯
                // ...
            })();`;
            
            codeElement.textContent = bookmarkCode;
            codeArea.classList.remove('hidden');
        }

        // 設置事件監聽器
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const dropZone = document.getElementById('dropZone');

            fileInput.addEventListener('change', function(e) {
                console.log('檔案選擇事件觸發'); // 除錯日誌
                const file = e.target.files[0];
                if (file) {
                    handleFile(file);
                }
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                console.log('檔案拖放事件觸發'); // 除錯日誌
                const file = e.dataTransfer.files[0];
                if (file) {
                    handleFile(file);
                }
            });

            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
        });
    </script>
</body>
</html>
