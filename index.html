<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>廣告替換工具</title>
    <!-- 使用更可靠的 CDN -->
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            background: #fafafa;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .preview-table th, .preview-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .hidden {
            display: none;
        }
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>廣告替換工具</h1>
        
        <div id="status"></div>

        <div class="upload-area" id="dropZone">
            <input type="file" id="fileInput" accept=".csv">
            <p>選擇或拖放 CSV 檔案至此處</p>
            <p style="color: #666;">支援的欄位：imageUrl, title, brand, size</p>
        </div>

        <div id="previewArea" class="hidden">
            <h2>預覽資料</h2>
            <div id="previewContent"></div>
        </div>

        <div id="codeArea" class="hidden">
            <h2>書籤代碼</h2>
            <pre id="bookmarkCode" style="background:#f8f8f8;padding:15px;border-radius:4px;white-space:pre-wrap;"></pre>
            <button class="button" onclick="copyToClipboard()">複製代碼</button>
        </div>
    </div>

    <script>
        // 狀態顯示函數
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.style.background = type === 'error' ? '#ffebee' : '#e8f5e9';
            statusDiv.style.display = 'block';
        }

        // 處理檔案上傳
        function processFile(file) {
            showStatus('正在處理檔案...');
            
            if (!window.Papa) {
                showStatus('CSV 解析器尚未載入，請重新整理頁面', 'error');
                return;
            }

            window.Papa.parse(file, {
                header: true,
                complete: function(results) {
                    if (results.errors.length) {
                        showStatus('CSV 解析錯誤: ' + results.errors[0].message, 'error');
                        return;
                    }

                    const data = results.data;
                    if (!data.length) {
                        showStatus('CSV 檔案沒有資料', 'error');
                        return;
                    }

                    // 顯示預覽
                    showPreview(data);
                    // 生成書籤代碼
                    generateBookmarkCode(data);
                    showStatus('處理完成！');
                },
                error: function(error) {
                    showStatus('檔案處理錯誤: ' + error.message, 'error');
                }
            });
        }

        // 顯示預覽
        function showPreview(data) {
            const previewArea = document.getElementById('previewArea');
            const content = document.getElementById('previewContent');
            
            let table = '<table class="preview-table"><tr>';
            const headers = Object.keys(data[0]);
            headers.forEach(header => table += `<th>${header}</th>`);
            table += '</tr>';
            
            data.forEach(row => {
                table += '<tr>';
                headers.forEach(header => table += `<td>${row[header] || ''}</td>`);
                table += '</tr>';
            });
            table += '</table>';
            
            content.innerHTML = table;
            previewArea.classList.remove('hidden');
        }

        // 生成書籤代碼
        function generateBookmarkCode(data) {
            const code = `javascript:(function(){
                const adData = ${JSON.stringify(data)};
                // 後續的廣告替換邏輯...
            })();`;
            
            document.getElementById('bookmarkCode').textContent = code;
            document.getElementById('codeArea').classList.remove('hidden');
        }

        // 複製到剪貼板
        function copyToClipboard() {
            const code = document.getElementById('bookmarkCode').textContent;
            navigator.clipboard.writeText(code)
                .then(() => showStatus('代碼已複製到剪貼板！'))
                .catch(() => showStatus('複製失敗，請手動複製', 'error'));
        }

        // 設置事件監聽
        document.getElementById('fileInput').addEventListener('change', event => {
            const file = event.target.files[0];
            if (file) processFile(file);
        });

        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('dragover', e => e.preventDefault());
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });

        // 檢查 Papa Parse 是否載入
        window.onload = function() {
            if (!window.Papa) {
                showStatus('無法載入 CSV 解析器，請重新整理頁面', 'error');
            } else {
                showStatus('系統已準備就緒，請選擇 CSV 檔案');
            }
        };
    </script>
</body>
</html>
