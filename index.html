<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>廣告替換工具</title>
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <!-- 樣式保持不變 -->
    <style>
        /* 原有樣式 */
    </style>
</head>
<body>
    <!-- HTML 結構保持不變 -->
    <script>
        function processFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                Papa.parse(file, {
                    header: true,
                    encoding: 'big5', // 指定編碼
                    complete: function(results) {
                        if (results.errors.length) {
                            showStatus('CSV 解析錯誤', 'error');
                            return;
                        }
                        showPreview(results.data);
                        generateBookmarkCode(results.data);
                    }
                });
            };
            reader.readAsText(file, 'big5'); // 指定使用 big5 編碼
        }

        function generateBookmarkCode(data) {
            const code = `javascript:(function(){
                try {
                    // 儲存原始資料
                    const adData = ${JSON.stringify(data)};
                    
                    // 按尺寸分組並追蹤每個尺寸的當前索引
                    const sizeGroups = {};
                    const sizeIndices = {};
                    
                    adData.forEach(ad => {
                        if (!sizeGroups[ad.size]) {
                            sizeGroups[ad.size] = [];
                            sizeIndices[ad.size] = 0;
                        }
                        sizeGroups[ad.size].push(ad);
                    });
                    
                    let replacedCount = 0;
                    const selectors = [
                        'ins.adsbygoogle',
                        'div[id^="google_ads_iframe"]',
                        'div[id^="div-gpt-ad"]',
                        'div[data-ad-client]',
                        'div[class*="gpt-ad"]',
                        'iframe[id^="google_ads_iframe"]',
                        'div[class*="adsky"]'
                    ];
                    
                    selectors.forEach(selector => {
                        document.querySelectorAll(selector).forEach(ad => {
                            const size = ad.offsetWidth + 'x' + ad.offsetHeight;
                            
                            if (sizeGroups[size] && sizeGroups[size].length > 0) {
                                // 取得當前索引的廣告
                                const currentIndex = sizeIndices[size];
                                const item = sizeGroups[size][currentIndex];
                                
                                // 更新索引，實現循環
                                sizeIndices[size] = (currentIndex + 1) % sizeGroups[size].length;
                                
                                const adContainer = ad.tagName === 'IFRAME' ? ad.parentElement : ad;
                                
                                // 設置基本樣式
                                adContainer.style.cssText = \`
                                    width: \${ad.offsetWidth}px;
                                    height: \${ad.offsetHeight}px;
                                    overflow: hidden;
                                    position: relative;
                                    \${ad.offsetWidth === 970 ? 'display: flex;' : ''}
                                \`;
                                
                                // 根據尺寸設置內容
                                if (ad.offsetWidth === 300 && ad.offsetHeight === 250) {
                                    adContainer.innerHTML = \`
                                        <div style="width:300px;height:157px;overflow:hidden">
                                            <img src="\${item.imageUrl}" style="width:300px;height:157px;display:block">
                                        </div>
                                        <div style="height:93px;padding:12px 25px 0 25px;position:relative">
                                            <div style="font-size:18px;line-height:1.5;font-weight:bold;height:54px;overflow:hidden">\${item.title}</div>
                                            <div style="font-size:9px;color:#999999;position:absolute;bottom:15px;left:25px">\${item.brand}</div>
                                            <div style="position:absolute;bottom:15px;right:25px;background:#4397F1;color:white;font-size:10px;padding:3px 8px;border-radius:4px;font-weight:bold">開啟</div>
                                        </div>
                                    \`;
                                } else if (ad.offsetWidth === 970 && ad.offsetHeight === 250) {
                                    adContainer.innerHTML = \`
                                        <div style="width:478px;height:250px;overflow:hidden">
                                            <img src="\${item.imageUrl}" style="width:478px;height:250px;display:block">
                                        </div>
                                        <div style="width:492px;height:250px;padding:20px 25px;position:relative;box-sizing:border-box">
                                            <div style="font-size:26px;line-height:1.8;font-weight:bold;color:#666666;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">\${item.title}</div>
                                            <div style="font-size:13px;color:#999999;position:absolute;bottom:20px;left:25px">\${item.brand}</div>
                                            <div style="position:absolute;bottom:20px;right:25px;background:#4397F1;color:white;font-size:14px;padding:4px 10px;border-radius:4px;font-weight:bold">開啟</div>
                                        </div>
                                    \`;
                                }
                                
                                replacedCount++;
                            }
                        });
                    });
                    
                    // 顯示替換報告
                    const report = Object.entries(sizeGroups).map(([size, ads]) => 
                        \`\${size}: 共使用了 \${ads.length} 個不同廣告\`
                    ).join('\\n');
                    
                    alert(\`廣告替換完成！\\n\\n\${report}\\n\\n總計替換: \${replacedCount} 個廣告位\`);
                } catch(e) {
                    alert('發生錯誤：' + e.message);
                }
            })();`;
            
            document.getElementById('bookmarkCode').textContent = code;
            document.getElementById('codeArea').classList.remove('hidden');
        }

        // 其他輔助函數保持不變
    </script>
</body>
</html>
